\subsection{Availability Measurement}
\label{sec:p2p:availability}

When learning about a new node, it remains unclear to the initiator of the connection whether this node is available or not. Since nodes might temporariliy or permanently leave the network, this also applies to already known nodes. Sending a mixnet packet requires a randomly sampled path through the network, it becomes necessary to estimate a nodes' availability and to provide a list of nodes the are expected to be online. Note that nodes cannot ping nodes just before they use them as a relay node because this would reveal the chosen path, hence nodes need to continuously and independently grow their view of availability of other nodes.

Within the HOPR network, this is achieved by using a heartbeat mechanism that continuously sends ping requests to other nodes. A node is considered online if it replied to a \textit{PING} attempt with a correct \textit{PONG} response or if the node has recently received a \textit{PING} request by that node.

Each node counts successful and unsuccessful \textit{PING} attempts and uses this information to create a health score for other nodes. To prevent from continuously probing offline nodes, the heartbeat mechanism increases the probing interval in case the node was not reachable.

\subsubsection{Ping mechanism}
\label{sec:p2p:ping-mechanism}

Pinging a node means sampling a random 16 byte string $r$ and asking the counterparty to return $response = SHA256(r)$. If the received response does not match the expected value, the response is considered invalid since it might stem from a previous attempt.

\subsubsection{Health Score}
\label{sec:p2p:health-score}

At startup, each node starts with a list of all nodes to which it has a funded outgoing payment channel, see section describing the \lcnameref{sec:incentives} for further details. Nodes on the list start with a initial health score of $0.2$. Whenever the node successfully pings a node on the list or the node passively gets pinged by that node, their health score increases by $0.1$ up to a maximum of $1.0$. Analogously, each unsuccessful attempt decreases the health score by $0.1$ down to $0$ which means that the node is considered offline.

Nodes with a health score greater than $0.5$ are expected to have a sufficiently high availability and can be used as a relay when sampling a mixnet path.

\subsubsection{Exponential Backoff}
\label{sec:p2p:exponential-backoff}

Since the network status can change abruptly, e.g., due to electricity outages or unstable network links, availability needs to be measured frequently on an ongoing basis. On the other hand, it does not make sense to constantly probe nodes that are known to be offline. To provide a dynamic trade-off for both cases, HOPR utilizes a heartbeat with exponential backoff, the time until the next \textit{ping} is sent to a node increases with the number of failed ping attempts $n_{fail}$ since the last sucessful attempt or the network start. A successful response to \textit{ping} resets the backoff timer.

$$ t_{bo} = {t_{base}}^{{f_{bo}}^{n_{fail}}} $$

where $t_{bo}$ is the backoff time, $t_{base} = 2s$ is the initial backoff time and $f_{bo} = 1.5$.

The maximal backoff time of 512 seconds corresponds to $n_{fail} = 5$.

